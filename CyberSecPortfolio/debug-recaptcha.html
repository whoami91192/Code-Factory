<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reCAPTCHA v3 Debug Test</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LcLUIkrAAAAEHbhqGdvIi6YPy93ghOu1BO0N0E" async defer></script>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff41;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #00ff41;
            border-radius: 4px;
        }
        button {
            background: #00ff41;
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc33;
        }
        .error {
            border-left-color: #ff4444;
            color: #ff6666;
        }
        .success {
            border-left-color: #44ff44;
            color: #66ff66;
        }
        .info {
            border-left-color: #4444ff;
            color: #6666ff;
        }
    </style>
</head>
<body>
    <h1>üîí reCAPTCHA v3 Debug Test</h1>
    <p>Site Key: <code>6LcLUIkrAAAAEHbhqGdvIi6YPy93ghOu1BO0N0E</code></p>
    
    <div id="status" class="log info">Initializing...</div>
    
    <button onclick="checkStatus()">Check reCAPTCHA Status</button>
    <button onclick="generateToken()">Generate Token</button>
    <button onclick="testAPI()">Test API with Token</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    
    <script>
        const SITE_KEY = '6LcLUIkrAAAAEHbhqGdvIi6YPy93ghOu1BO0N0E';
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5173' 
            : 'https://code-factory-gamma.vercel.app';
        
        let currentToken = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logDiv);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `log ${type}`;
            statusDiv.innerHTML = message;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function checkStatus() {
            log('üîç Checking reCAPTCHA status...');
            
            if (typeof grecaptcha === 'undefined') {
                log('‚ùå grecaptcha is undefined', 'error');
                updateStatus('‚ùå reCAPTCHA script not loaded', 'error');
                return;
            }
            
            log('‚úÖ grecaptcha object exists');
            
            if (typeof grecaptcha.ready !== 'function') {
                log('‚ùå grecaptcha.ready is not a function', 'error');
                updateStatus('‚ùå reCAPTCHA ready function missing', 'error');
                return;
            }
            
            log('‚úÖ grecaptcha.ready function exists');
            
            if (typeof grecaptcha.execute !== 'function') {
                log('‚ùå grecaptcha.execute is not a function', 'error');
                updateStatus('‚ùå reCAPTCHA execute function missing', 'error');
                return;
            }
            
            log('‚úÖ grecaptcha.execute function exists');
            updateStatus('‚úÖ reCAPTCHA fully loaded and ready', 'success');
        }
        
        function generateToken() {
            log('üîí Attempting to generate reCAPTCHA token...');
            
            if (typeof grecaptcha === 'undefined') {
                log('‚ùå grecaptcha not available', 'error');
                return;
            }
            
            grecaptcha.ready(function() {
                log('üìû grecaptcha.ready callback fired');
                
                grecaptcha.execute(SITE_KEY, {action: 'debug_test'})
                    .then(function(token) {
                        currentToken = token;
                        log(`‚úÖ Token generated successfully!`, 'success');
                        log(`üìù Token preview: ${token.substring(0, 50)}...`, 'info');
                        log(`üìè Token length: ${token.length} characters`, 'info');
                        updateStatus('‚úÖ Token generated successfully', 'success');
                    })
                    .catch(function(error) {
                        log(`‚ùå Token generation failed: ${error.message}`, 'error');
                        updateStatus('‚ùå Token generation failed', 'error');
                    });
            });
        }
        
        async function testAPI() {
            if (!currentToken) {
                log('‚ùå No token available. Generate a token first.', 'error');
                return;
            }
            
            log('üì§ Testing API with generated token...');
            
            try {
                const response = await fetch(`${API_BASE}/api/contact`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'Debug Test User',
                        email: 'debug@example.com',
                        subject: 'reCAPTCHA v3 Debug Test',
                        message: 'This is a debug test message to verify reCAPTCHA v3 integration.',
                        captchaToken: currentToken
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ API call successful!`, 'success');
                    log(`üìä Response: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    log(`‚ùå API call failed with status ${response.status}`, 'error');
                    log(`üìä Error response: ${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            log('üöÄ Page loaded, waiting for reCAPTCHA...');
            
            // Wait a bit for reCAPTCHA to load
            setTimeout(() => {
                checkStatus();
            }, 1000);
        });
        
        // Monitor for reCAPTCHA loading
        let checkInterval = setInterval(() => {
            if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
                log('‚úÖ reCAPTCHA detected!', 'success');
                clearInterval(checkInterval);
                updateStatus('‚úÖ reCAPTCHA loaded successfully', 'success');
            }
        }, 500);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            if (typeof grecaptcha === 'undefined') {
                log('‚ùå reCAPTCHA failed to load after 10 seconds', 'error');
                updateStatus('‚ùå reCAPTCHA load timeout', 'error');
                clearInterval(checkInterval);
            }
        }, 10000);
    </script>
</body>
</html> 